

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fatDAE.class_solvers &mdash; FATDAE beta documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> FATDAE
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FATDAE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>fatDAE.class_solvers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fatDAE.class_solvers</h1><div class="highlight"><pre>
<span></span><span class="c1"># Date: 23/06/2018</span>
<span class="c1"># Auth: Manuel Cremades, manuel.cremades@usc.es</span>

<span class="c1"># Basic modules</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;..&#39;</span><span class="p">);</span> <span class="kn">from</span> <span class="nn">fatDAE.base.basic_import</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># User defined</span>
<span class="kn">from</span> <span class="nn">fatDAE.base</span> <span class="kn">import</span> <span class="n">class_solvers_nl</span>
<span class="kn">from</span> <span class="nn">fatDAE.base</span> <span class="kn">import</span> <span class="n">class_solvers_sp</span>

<span class="kn">import</span> <span class="nn">fatDAE.class_butcher</span>
<span class="kn">import</span> <span class="nn">fatDAE.class_problem</span>

<div class="viewcode-block" id="build"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.build">[docs]</a><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">butcher_json</span><span class="p">,</span> <span class="n">embedded_1</span><span class="p">,</span> <span class="n">embedded_2</span><span class="p">,</span> <span class="n">a_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">r_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">s_fac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">f_max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">f_min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">h_max</span><span class="o">=</span><span class="mf">1.e+3</span><span class="p">,</span> <span class="n">h_min</span><span class="o">=</span><span class="mf">1.e-12</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Instances a solver from a Butcher table.</span>

<span class="sd">    Args:</span>
<span class="sd">        butcher_json (:obj:`dict`):</span>
<span class="sd">        embedded_1 (:obj:`bool`): True if the first method is going to be embedded, False otherwise.</span>
<span class="sd">        embedded_2 (:obj:`bool`): True if the second method is going to be embedded, False otherwise.</span>

<span class="sd">    Returns:</span>
<span class="sd">        solver (:obj:`Solver`):</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">butcher_json</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RW&#39;</span><span class="p">:</span>

        <span class="n">advancing_table</span> <span class="o">=</span> <span class="n">fatDAE</span><span class="o">.</span><span class="n">class_butcher</span><span class="o">.</span><span class="n">Generalized</span><span class="p">(</span><span class="n">butcher_json</span><span class="p">,</span> <span class="n">embedded_1</span><span class="p">)</span>
        <span class="n">estimator_table</span> <span class="o">=</span> <span class="n">fatDAE</span><span class="o">.</span><span class="n">class_butcher</span><span class="o">.</span><span class="n">Generalized</span><span class="p">(</span><span class="n">butcher_json</span><span class="p">,</span> <span class="n">embedded_2</span><span class="p">)</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">RW</span><span class="p">(</span><span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="p">,</span> <span class="n">r_tol</span><span class="p">,</span> <span class="n">s_fac</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_min</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">advancing_table</span> <span class="o">=</span> <span class="n">fatDAE</span><span class="o">.</span><span class="n">class_butcher</span><span class="o">.</span><span class="n">Butcher</span><span class="p">(</span><span class="n">butcher_json</span><span class="p">,</span> <span class="n">embedded_1</span><span class="p">)</span>
        <span class="n">estimator_table</span> <span class="o">=</span> <span class="n">fatDAE</span><span class="o">.</span><span class="n">class_butcher</span><span class="o">.</span><span class="n">Butcher</span><span class="p">(</span><span class="n">butcher_json</span><span class="p">,</span> <span class="n">embedded_2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">butcher_json</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DIRK&#39;</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">DIRK</span><span class="p">(</span><span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="p">,</span> <span class="n">r_tol</span><span class="p">,</span> <span class="n">s_fac</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_min</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">butcher_json</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SDIRK&#39;</span><span class="p">:</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">SDIRK</span><span class="p">(</span><span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="p">,</span> <span class="n">r_tol</span><span class="p">,</span> <span class="n">s_fac</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_min</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">butcher_json</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EDIRK&#39;</span><span class="p">:</span>
                    <span class="n">solver</span> <span class="o">=</span> <span class="n">EDIRK</span><span class="p">(</span><span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="p">,</span> <span class="n">r_tol</span><span class="p">,</span> <span class="n">s_fac</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_min</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">butcher_json</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ESDIRK&#39;</span><span class="p">:</span>
                        <span class="n">solver</span> <span class="o">=</span> <span class="n">ESDIRK</span><span class="p">(</span><span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="p">,</span> <span class="n">r_tol</span><span class="p">,</span> <span class="n">s_fac</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_min</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Unknown method or method not implemented yet...&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">solver</span></div>

<div class="viewcode-block" id="Solver"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.Solver">[docs]</a><span class="k">class</span> <span class="nc">Solver</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39; Abstract class for a solver.</span>

<span class="sd">    .. inheritance-diagram:: LM ERK FIRK ESDIRK SDIRK RW</span>
<span class="sd">       :parts: 1</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="LM"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.LM">[docs]</a><span class="k">class</span> <span class="nc">LM</span><span class="p">(</span><span class="n">Solver</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Abstract class for a linear multistep solver.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK">[docs]</a><span class="k">class</span> <span class="nc">RK</span><span class="p">(</span><span class="n">Solver</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Abstract class for a Runge-Kutta solver.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        advancing_table (:obj:`runge_kutta.class_butcher.Butcher`): Butcher table defining the advancing method.</span>
<span class="sd">        estimator_table (:obj:`runge_kutta.class_butcher.Butcher`): Butcher table defining the estimator method.</span>
<span class="sd">        f_max (:obj:`float`): Maximum step size increasing factor.</span>
<span class="sd">        f_min (:obj:`float`): Maximum step size decreasing factor.</span>
<span class="sd">        a_tol (:obj:`float`): Absolute tolerance.</span>
<span class="sd">        r_tol (:obj:`float`): Relative tolerance.</span>
<span class="sd">        s_fac (:obj:`float`): Safety factor used to reduce step rejections.</span>
<span class="sd">        q (:obj:`int`): Minimum order of the methods.</span>
<span class="sd">        r (:obj:`int`): Maximum order of the methods.</span>
<span class="sd">        name (:obj:`str`): Name of the embedded Runge-Kutta method, including type and order of both methods.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">r_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">s_fac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">f_max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">f_min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">h_max</span><span class="o">=</span><span class="mf">1.e+3</span><span class="p">,</span> <span class="n">h_min</span><span class="o">=</span><span class="mf">1.e-12</span><span class="p">):</span>

        <span class="c1"># Butcher table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span> <span class="o">=</span> <span class="n">advancing_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator_table</span> <span class="o">=</span> <span class="n">estimator_table</span>

        <span class="c1"># Absolute and relative tolerances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_tol</span> <span class="o">=</span> <span class="n">a_tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_tol</span> <span class="o">=</span> <span class="n">r_tol</span>

        <span class="c1"># Safety factor for time stepping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_fac</span> <span class="o">=</span> <span class="n">s_fac</span>

        <span class="c1"># Bounds for stepsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">f_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">f_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_max</span> <span class="o">=</span> <span class="n">h_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_min</span> <span class="o">=</span> <span class="n">h_min</span>

        <span class="c1"># Minimum and maximum order of the methods involved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_table</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_table</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Name of the method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> \
                                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> \
                                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimator_table</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

<div class="viewcode-block" id="RK.solve_fxd"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.solve_fxd">[docs]</a>    <span class="k">def</span> <span class="nf">solve_fxd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">state_machine</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tlm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Solves a problem with fixed step size.</span>

<span class="sd">        Args:</span>
<span class="sd">            problem (:obj:`runge_kutta.class_problem.Control`)</span>
<span class="sd">            h (:obj:`float`): Step size.</span>
<span class="sd">            adj (:obj:`bool`): True if adjoint method will be used, False otherwise.</span>
<span class="sd">            tlm (:obj:`bool`): True if tangent method will be used, False otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">=</span> <span class="n">tlm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">=</span> <span class="n">state_machine</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span> \
                      <span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span><span class="p">,</span> \
                      <span class="s1">&#39;x_k&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span><span class="p">,</span> \
                      <span class="s1">&#39;h_k&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> \
                      <span class="s1">&#39;t_0&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">t_0</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">actual_state</span><span class="o">.</span><span class="n">exec_ini</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve_initial</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">x_0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving...&quot;</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time -&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tstep_frw</span><span class="p">()</span>

            <span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
            <span class="n">x_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
                <span class="n">x_k</span> <span class="o">=</span> <span class="n">x_k</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trigged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span> \
                          <span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="n">x_0</span><span class="p">,</span> \
                          <span class="s1">&#39;x_k&#39;</span><span class="p">:</span> <span class="n">x_k</span><span class="p">,</span> \
                          <span class="s1">&#39;h_k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> \
                          <span class="s1">&#39;t_0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">}</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">trigged</span><span class="p">,</span> <span class="n">accept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">actual_state</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">fatDAE</span><span class="o">.</span><span class="n">class_machine</span><span class="o">.</span><span class="n">End</span><span class="p">()):</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

                    <span class="k">return</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">trigged</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>

                <span class="k">if</span> <span class="n">accept</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">tstep_tlm</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">updat_tlm</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve_initial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">updat_frw</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">tstep_tlm</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">updat_frw</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">updat_tlm</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="RK.solve_adp"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.solve_adp">[docs]</a>    <span class="k">def</span> <span class="nf">solve_adp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">state_machine</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tlm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Solves a problem with adaptive step size.</span>

<span class="sd">        Args:</span>
<span class="sd">            problem (:obj:`runge_kutta.class_problem.Control`)</span>
<span class="sd">            h (:obj:`float`): Step size.</span>
<span class="sd">            adj (:obj:`bool`): True if adjoint method will be used, False otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">=</span> <span class="n">tlm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">=</span> <span class="n">state_machine</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span> \
                      <span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span><span class="p">,</span> \
                      <span class="s1">&#39;x_k&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span><span class="p">,</span> \
                      <span class="s1">&#39;h_k&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> \
                      <span class="s1">&#39;t_0&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="o">.</span><span class="n">t_0</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">actual_state</span><span class="o">.</span><span class="n">exec_ini</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve_initial</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">x_0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving...&quot;</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time -&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_min</span><span class="p">:</span>

                <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Minimum stepsize reached...&#39;</span><span class="p">)</span>

                <span class="k">return</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_max</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_max</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tstep_frw</span><span class="p">()</span>

            <span class="n">x_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
            <span class="n">x_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
                <span class="n">x_k</span> <span class="o">=</span> <span class="n">x_k</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trigged</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span> \
                          <span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="n">x_0</span><span class="p">,</span> \
                          <span class="s1">&#39;x_k&#39;</span><span class="p">:</span> <span class="n">x_k</span><span class="p">,</span> \
                          <span class="s1">&#39;h_k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> \
                          <span class="s1">&#39;t_0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">}</span>

                <span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">trigged</span><span class="p">,</span> <span class="n">accept</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">actual_state</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">fatDAE</span><span class="o">.</span><span class="n">class_machine</span><span class="o">.</span><span class="n">End</span><span class="p">()):</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accept. steps: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reject. steps: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Diverg. steps: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span><span class="p">)</span>

                    <span class="k">return</span> <span class="mi">2</span>

            <span class="k">if</span> <span class="n">trigged</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>

                <span class="k">if</span> <span class="n">accept</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tstep_tlm</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">updat_tlm</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve_initial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="mf">1.0</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nlsolver&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;nlsolver&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">converged</span><span class="p">):</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_est</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">updat_frw</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tstep_tlm</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">updat_frw</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">updat_tlm</span><span class="p">()</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">store_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;problem&#39;</span><span class="p">:</span> <span class="n">problem</span><span class="p">,</span> \
                                      <span class="s1">&#39;x_0&#39;</span><span class="p">:</span> <span class="n">x_0</span><span class="p">,</span> \
                                      <span class="s1">&#39;x_k&#39;</span><span class="p">:</span> <span class="n">x_k</span><span class="p">,</span> \
                                      <span class="s1">&#39;h_k&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> \
                                      <span class="s1">&#39;t_0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">}</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">actual_state</span><span class="o">.</span><span class="n">exec_dur</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">accept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">])</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Elapsed time: &quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accept. steps: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reject. steps: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Diverg. steps: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum simulation time exceeded&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="RK.solve_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.solve_adj">[docs]</a>    <span class="k">def</span> <span class="nf">solve_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">state_machine</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">adp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Solves an optimization problem and computes the gradient of a cost function by the adjoint method.</span>

<span class="sd">        The adjoint state is initialized as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\boldsymbol{\\lambda}_N = \\frac{\\partial J}{\\partial \\mathbf{x}}(\\mathbf{x}_N, \\mathbf{u})</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        The gradient of the cost function is initialized as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\nabla{\\Psi} = \\frac{\\partial J}{\\partial \\mathbf{u}}(\\mathbf{x}_N, \\mathbf{u})</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        Args:</span>
<span class="sd">            problem (:obj:`runge_kutta.class_problem.Control`)</span>
<span class="sd">            h (:obj:`float`): Step size.</span>
<span class="sd">            adp (:obj:`bool`): True if adaptive step size will be used, False otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RK.setup_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.setup_frw">[docs]</a>    <span class="k">def</span> <span class="nf">setup_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Configures the solver for one forward resolution.</span>

<span class="sd">        Args:</span>
<span class="sd">            problem (:obj:`runge_kutta.class_problem.Problem`)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">t_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">x_0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta_x</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_y</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">f</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta_K</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_L</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">J</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">g</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t_0</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">t_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_f</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">t_f</span>

        <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_f</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_steps</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_list</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="RK.setup_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.setup_adj">[docs]</a>    <span class="k">def</span> <span class="nf">setup_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Configures the solver for one adjoint resolution.</span>

<span class="sd">        Args:</span>
<span class="sd">            problem (:obj:`runge_kutta.class_problem.Control`)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_frw</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">J</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dJdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dJdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dJdx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dJdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dJdx</span>

            <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dJdu</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dJdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dJdu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dJdu</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dJdu</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dgdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dgdx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dgdx</span>

            <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dgdu</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dgdu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdu</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dgdu</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdu</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dfdu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdu</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dMdu</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dMdu</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dMdu</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">build_transposed</span><span class="p">()</span></div>

<div class="viewcode-block" id="RK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK.tstep_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.tstep_adj">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK.tstep_tlm"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.tstep_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one tangent time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK.updat_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.updat_frw">[docs]</a>    <span class="k">def</span> <span class="nf">updat_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the state and cost function after one forward time step.</span>

<span class="sd">        The state is updated as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">        	   \\mathbf{x}_{n+1} = \\mathbf{x}_{n} + \\sum_{i=1}^{s}b_i\\mathbf{k}_i</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        once the stage vectors are computed by :meth:`tstep_frw`.</span>

<span class="sd">        The cost function is updated as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">        	   \\Psi = \\Psi + h_n \\sum_{i=1}^{s}b_i g(t, \\mathbf{x}_n + \\sum_{j=1}^{s}a_{ij}\\mathbf{k}_j)</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        once the stage vectors are computed by :meth:`tstep_frw`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
             <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>

             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

                 <span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                 <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cst</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span></div>

<div class="viewcode-block" id="RK.updat_bkw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.updat_bkw">[docs]</a>    <span class="k">def</span> <span class="nf">updat_bkw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the state after one backward time step.</span>

<span class="sd">        The state is updated as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">        	   \\mathbf{x}_{n} = \\mathbf{x}_{n + 1} - \\sum_{i=1}^{s}b_i\\mathbf{k}_i</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        once the stage vectors are computed by :meth:`tstep_frw`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span></div>

<div class="viewcode-block" id="RK.updat_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.updat_adj">[docs]</a>    <span class="k">def</span> <span class="nf">updat_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the adjoint state and gradient of the cost function after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updat_lmb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updat_grd</span><span class="p">()</span></div>

<div class="viewcode-block" id="RK.updat_tlm"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.updat_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">updat_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the tangent state after one tangent time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="RK.updat_lmb"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.updat_lmb">[docs]</a>    <span class="k">def</span> <span class="nf">updat_lmb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the adjoint state after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK.updat_grd"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.updat_grd">[docs]</a>    <span class="k">def</span> <span class="nf">updat_grd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the gradient of the cost function after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK.store_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.store_frw">[docs]</a>    <span class="k">def</span> <span class="nf">store_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Store the state after one forward time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">h_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">K_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">L_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="RK.state_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.state_frw">[docs]</a>    <span class="k">def</span> <span class="nf">state_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute :math:`i`-th forward intermediate time and state.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>

        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span></div>

<div class="viewcode-block" id="RK.state_bkw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.state_bkw">[docs]</a>    <span class="k">def</span> <span class="nf">state_bkw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute :math:`i`-th bckward intermediate time and state.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>

        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span></div>

<div class="viewcode-block" id="RK.adapt"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.adapt">[docs]</a>    <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adjust the step size after one forward time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_fac</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_est</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))))</span></div>

<div class="viewcode-block" id="RK.check"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if the local error estimate is under the specified tolerance.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">x_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="n">x_new</span> <span class="o">=</span> <span class="n">x_new</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">y_new</span> <span class="o">=</span> <span class="n">y_new</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">error_est</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">x_new</span><span class="p">,</span> <span class="n">y_new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_tol</span><span class="p">)</span></div>

<div class="viewcode-block" id="RK.event_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.event_frw">[docs]</a>    <span class="k">def</span> <span class="nf">event_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_frw</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_1</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_1</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">g_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_1</span></div>

<div class="viewcode-block" id="RK.event_bkw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.event_bkw">[docs]</a>    <span class="k">def</span> <span class="nf">event_bkw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RK.fd_dfdx"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.fd_dfdx">[docs]</a>    <span class="k">def</span> <span class="nf">fd_dfdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes source derivative with respect to the state by finite differences.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span> <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">r_tol</span> <span class="o">*</span> <span class="n">y</span>
            <span class="n">A</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">r_tol</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">r_tol</span> <span class="o">*</span> <span class="n">y</span>

        <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span></div>

<div class="viewcode-block" id="RK.fd_dMdx"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RK.fd_dMdx">[docs]</a>    <span class="k">def</span> <span class="nf">fd_dMdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes matrix directional derivative with respect to the state by finite differences.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\partial M}{\partial \\mathbf{x}}(t, \\mathbf{x})\\mathbf{y} = \\lim_{\\epsilon \\rightarrow 0}\\frac{M(t, \\mathbf{x} + \\epsilon\\mathbf{y}) - M(t, \\mathbf{x})}{\\epsilon}</span>
<span class="sd">            \\end{equation}</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">r_tol</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">r_tol</span></div></div>

<div class="viewcode-block" id="ERK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ERK">[docs]</a><span class="k">class</span> <span class="nc">ERK</span><span class="p">(</span><span class="n">RK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Explicit Runge-Kutta solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc}</span>
<span class="sd">            c_1     &amp; 0       &amp; 0       &amp; \\cdots &amp; 0       \\\\</span>
<span class="sd">            \\vdots &amp; a_{21}  &amp; 0       &amp; \\ddots &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\vdots &amp; \\ddots &amp; 0       \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; a_{s2}  &amp; \\cdots &amp; 0       \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">class_solvers</span><span class="o">.</span><span class="n">RK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

<div class="viewcode-block" id="ERK.updat_lmb"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ERK.updat_lmb">[docs]</a>    <span class="k">def</span> <span class="nf">updat_lmb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the adjoint state after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ERK.updat_grd"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ERK.updat_grd">[docs]</a>    <span class="k">def</span> <span class="nf">updat_grd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the gradient of the cost function after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ERK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ERK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ERK.tstep_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ERK.tstep_adj">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ERK.tstep_tlm"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ERK.tstep_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one tangent time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="IRK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.IRK">[docs]</a><span class="k">class</span> <span class="nc">IRK</span><span class="p">(</span><span class="n">RK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Abstract class for a implicit Runge-Kutta solver.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">RK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span> <span class="o">=</span> <span class="n">class_solvers_nl</span><span class="o">.</span><span class="n">solver_nt</span><span class="p">()</span>

<div class="viewcode-block" id="IRK.setup_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.IRK.setup_frw">[docs]</a>    <span class="k">def</span> <span class="nf">setup_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Configures the solver for one forward resolution.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">RK</span><span class="o">.</span><span class="n">setup_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dMdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dMdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dMdx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dMdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dMdx</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dfdx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdx</span></div>

<div class="viewcode-block" id="IRK.setup_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.IRK.setup_adj">[docs]</a>    <span class="k">def</span> <span class="nf">setup_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Configures the solver for one adjoint resolution.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">RK</span><span class="o">.</span><span class="n">setup_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="FIRK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.FIRK">[docs]</a><span class="k">class</span> <span class="nc">FIRK</span><span class="p">(</span><span class="n">IRK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Full implicit Runge-Kutta solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc}</span>
<span class="sd">            c_1     &amp; a_{11}  &amp; \\cdots &amp; \\cdots &amp; a_{1s}  \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\ddots &amp;         &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp;         &amp; \\ddots &amp; \\vdots \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; \\cdots &amp; \\cdots &amp; a_{ss}  \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">IRK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

<div class="viewcode-block" id="FIRK.updat_lmb"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.FIRK.updat_lmb">[docs]</a>    <span class="k">def</span> <span class="nf">updat_lmb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the adjoint state after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="FIRK.updat_grd"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.FIRK.updat_grd">[docs]</a>    <span class="k">def</span> <span class="nf">updat_grd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the gradient of the cost function after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="FIRK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.FIRK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="FIRK.tstep_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.FIRK.tstep_adj">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span></div></div>

<div class="viewcode-block" id="DIRK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK">[docs]</a><span class="k">class</span> <span class="nc">DIRK</span><span class="p">(</span><span class="n">IRK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Diagonally implicit Runge-Kutta solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc}</span>
<span class="sd">            c_1     &amp; a_{11}  &amp; 0       &amp; \\cdots &amp; 0       \\\\</span>
<span class="sd">            \\vdots &amp; a_{21}  &amp; a_{22}  &amp; \\ddots &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\vdots &amp; \\ddots &amp; 0       \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; a_{s2}  &amp; \\cdots &amp; a_{ss}  \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">IRK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

<div class="viewcode-block" id="DIRK.updat_lmb"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.updat_lmb">[docs]</a>    <span class="k">def</span> <span class="nf">updat_lmb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the adjoint state after one adjoint time step.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">            \\begin{split}</span>
<span class="sd">            \\boldsymbol{\\lambda}_{n} &amp; = \\boldsymbol{\\lambda}_{n+1}                                  \\\\</span>
<span class="sd">                                       &amp; + h_n\\sum_{i=1}^{s}b_i\\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}^T(t_{n} + c_ih, \\mathbf{x}_{n} + \sum_{j=1}^{s}a_{ij}\\mathbf{k}_j, \\mathbf{u})\\boldsymbol{\\xi}_{ni} \\\\</span>
<span class="sd">                                       &amp; + h_n\\sum_{i=1}^{s}b_i\\frac{\\partial           g}{\\partial \\mathbf{x}}^T(t_{n} + c_ih, \\mathbf{x}_{n} + \sum_{j=1}^{s}a_{ij}\\mathbf{k}_j, \\mathbf{u})</span>
<span class="sd">            \\end{split}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        with the matrices pre-computed by :meth:`stage_adj`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="DIRK.updat_grd"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.updat_grd">[docs]</a>    <span class="k">def</span> <span class="nf">updat_grd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the gradient of the cost function after one adjoint time step.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">            \\begin{split}</span>
<span class="sd">            \\nabla{\\Psi} &amp; = \\nabla{\\Psi}                                 \\\\</span>
<span class="sd">                           &amp; + h_n\\sum_{i=1}^{s}b_i\\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{u}}^T(t_{n} + c_ih, \\mathbf{x}_{n} + \sum_{j=1}^{s}a_{ij}\\mathbf{k}_j, \\mathbf{u})\\boldsymbol{\\xi}_{ni} \\\\</span>
<span class="sd">                           &amp; + h_n\\sum_{i=1}^{s}b_i\\frac{\\partial           g}{\\partial \\mathbf{u}}^T(t_{n} + c_ih, \\mathbf{x}_{n} + \sum_{j=1}^{s}a_{ij}\\mathbf{k}_j, \\mathbf{u})</span>
<span class="sd">            \\end{split}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        with the matrices pre-computed by :meth:`stage_adj`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="DIRK.stage_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.stage_frw">[docs]</a>    <span class="k">def</span> <span class="nf">stage_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Build one stage function and its derivative with respect to that stage.</span>

<span class="sd">        Stage function:</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\mathbf{F}_i(\\mathbf{k}_i) = M\\mathbf{k}_i - h\\mathbf{f}(t_n+c_ih,\\mathbf{xx}_n+\sum_{j=1}^{i}a_{ij}\\mathbf{k}_j)</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        Stage jacobian:</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                J_i(\\mathbf{k}_i) = M - ha_{ii}\\frac{\\partial \\mathbf{f}}{\\partial\\mathbf{x} }(t_n+c_ih,\\mathbf{x}_n+\sum_{j=1}^{i}a_{ij}\\mathbf{k}_j)</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        .. note::</span>
<span class="sd">            If :attr:`nlsolver.simplified` = True then only the stage function is returned.</span>

<span class="sd">        Args:</span>
<span class="sd">            i (:obj:`int`): Index of the intermediate stage.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): Tuple containing:</span>

<span class="sd">            - **F** (:obj:`function`): Stage function.</span>
<span class="sd">            - **J** (:obj:`function`): Stage jacobian.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

            <span class="k">return</span> <span class="n">M</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

            <span class="n">J</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">J</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dMdx</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
                    <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

                <span class="k">return</span> <span class="n">A</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span>

        <span class="k">return</span> <span class="n">F</span><span class="p">,</span> <span class="n">J</span></div>

<div class="viewcode-block" id="DIRK.stage_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.stage_adj">[docs]</a>    <span class="k">def</span> <span class="nf">stage_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute matrices and vectors required for one adjoint time step.</span>

<span class="sd">        In particular, it computes:</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t_n + c_ih, \\mathbf{x}_n + \sum_{j=1}^{i}a_{ij}\\mathbf{k}_j, \\mathbf{u}), \\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\\partial \\mathbf{g}}{\\partial \\mathbf{u}}(t_n + c_ih, \\mathbf{x}_n + \sum_{j=1}^{i}a_{ij}\\mathbf{k}_j, \\mathbf{u}), \\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t_n + c_ih, \\mathbf{x}_n + \sum_{j=1}^{i}a_{ij}\\mathbf{k}_j, \\mathbf{u}), \\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\\partial \\mathbf{g}}{\\partial \\mathbf{u}}(t_n + c_ih, \\mathbf{x}_n + \sum_{j=1}^{i}a_{ij}\\mathbf{k}_j, \\mathbf{u}), \\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        and store all of them in :attr:`dfdx_step`, :attr:`dfdu_step`, :attr:`dgdx_step` and :attr:`dgdu_step` respectively.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dMdu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgdu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span></div>

<div class="viewcode-block" id="DIRK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>

<span class="sd">        the forward stages are computed by solving the non-linear systems</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\mathbf{F}_i(\\mathbf{k}_i) = M\\mathbf{k}_i - h\\mathbf{f}(t_n+c_ih,\\mathbf{x}_n+\sum_{j=1}^{i}a_{ij}\\mathbf{k}_j),\\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        with jacobians</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                J_i(\\mathbf{k}_i) = M - ha_{ii}\\frac{\\partial \\mathbf{f}}{\\partial\\mathbf{x} }(t_n+c_ih,\\mathbf{x}_n+\sum_{j=1}^{i}a_{ij}\\mathbf{k}_j),\\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        both returned by :meth:`stage_frw` and which are solved sequentially using Newton interations.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If :attr:`nlsolver.simplified` = True then the matrices</span>

<span class="sd">            .. math::</span>
<span class="sd">                \\begin{equation}</span>
<span class="sd">                    J_i = M - ha_{ii}\\frac{\\partial \\mathbf{f}}{\\partial\\mathbf{x} }(t_n,\\mathbf{x}_n),\\quad i=1,\\dots, s</span>
<span class="sd">                \\end{equation}</span>

<span class="sd">            are used to perform simplified Newton iterations.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

                <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="n">J</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">F</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span></div>

<div class="viewcode-block" id="DIRK.tstep_tlm"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.tstep_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1">#TODO comment</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

            <span class="n">b_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_x</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">b_x</span> <span class="o">=</span> <span class="n">b_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_K</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">delta_K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span><span class="p">,</span> \
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">dfdx</span> <span class="o">*</span> <span class="n">b_x</span><span class="p">)</span></div>

<div class="viewcode-block" id="DIRK.tstep_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.DIRK.tstep_adj">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one adjoint time step.</span>

<span class="sd">        The adjoint stages are computed by solving the linear systems</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">            \\begin{split}</span>
<span class="sd">            (M - h_na_{ll}\\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t_{nl}, \\mathbf{x}_{nl}, \\mathbf{u}))^T\\boldsymbol{\\xi}_{nl} &amp; = \\boldsymbol{\\lambda}_{n+1}                                  \\\\</span>
<span class="sd">                                                           &amp; + h_n\\sum_{i=l+1}^{s}{a}^t_{li}\\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t_{ni}, \\mathbf{x}_{ni}, \\mathbf{u})^T\\boldsymbol{\\xi}_{ni} \\\\</span>
<span class="sd">                                                           &amp; + h_n\\sum_{i=l+0}^{s}{a}^t_{li}\\frac{\\partial           g}{\\partial \\mathbf{x}}(t_{ni}, \\mathbf{x}_{ni}, \\mathbf{u})^T, \\quad l=1,\\dots, s</span>
<span class="sd">            \\end{split}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        with the matrices pre-computed by :meth:`stage_adj`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

                    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

                    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span> \
                          <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SDIRK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.SDIRK">[docs]</a><span class="k">class</span> <span class="nc">SDIRK</span><span class="p">(</span><span class="n">DIRK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Singly diagonally implicit Runge-Kutta solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc}</span>
<span class="sd">            c_1     &amp; \\gamma &amp; 0       &amp; \\cdots &amp; 0       \\\\</span>
<span class="sd">            \\vdots &amp; a_{21}  &amp; \\gamma &amp; \\ddots &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\vdots &amp; \\ddots &amp; 0       \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; a_{s2}  &amp; \\cdots &amp; \\gamma \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">DIRK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

<div class="viewcode-block" id="SDIRK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.SDIRK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>

<span class="sd">        The stages are computed by solving the non-linear systems</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\mathbf{F}_i(\\mathbf{k}_i) = M\\mathbf{k}_i - h\\mathbf{f}(t_n+c_ih,\\mathbf{x}_n+\sum_{j=1}^{i}a_{ij}\\mathbf{k}_j),\\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        with jacobians</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                J_i(\\mathbf{k}_i) = M - h\\gamma\\frac{\\partial \\mathbf{f}}{\\partial\\mathbf{x} }(t_n+c_ih,\\mathbf{x}_n+\sum_{j=1}^{i}a_{ij}\\mathbf{k}_j),\\quad i=1,\\dots, s</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        both returned by :meth:`stage_frw` and which are solved sequentially using Newton interations.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If :attr:`nlsolver.simplified` = True then the matrix</span>

<span class="sd">            .. math::</span>
<span class="sd">                \\begin{equation}</span>
<span class="sd">                    J = M - h\\gamma\\frac{\\partial \\mathbf{f}}{\\partial\\mathbf{x} }(t_n,\\mathbf{y}_n)</span>
<span class="sd">                \\end{equation}</span>

<span class="sd">            is used to perform simplified Newton iterations.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

            <span class="n">J</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

                <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">F</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span></div></div>

<div class="viewcode-block" id="EDIRK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.EDIRK">[docs]</a><span class="k">class</span> <span class="nc">EDIRK</span><span class="p">(</span><span class="n">DIRK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Diagonally implicit Runge-Kutta with an explicit first stage solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc}</span>
<span class="sd">            c_1     &amp; 0       &amp; 0       &amp; \\cdots &amp; 0       \\\\</span>
<span class="sd">            \\vdots &amp; a_{21}  &amp; a_{22}  &amp; \\ddots &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\vdots &amp; \\ddots &amp; 0       \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; a_{s2}  &amp; \\cdots &amp; a_{ss}  \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">DIRK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lqsolver</span> <span class="o">=</span> <span class="n">class_solvers_sp</span><span class="o">.</span><span class="n">solver_lq</span><span class="p">()</span>

<div class="viewcode-block" id="EDIRK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.EDIRK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>

<span class="sd">        The first stage is computed explicitly as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                M\\mathbf{k}_1 = h\\mathbf{f}(t_n,\\mathbf{y}_n)</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        in contrast with :meth:`SDIRK.tstep_frw`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lqsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

                <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="n">J</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">F</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">dFdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span></div></div>

<div class="viewcode-block" id="ESDIRK"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ESDIRK">[docs]</a><span class="k">class</span> <span class="nc">ESDIRK</span><span class="p">(</span><span class="n">DIRK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Singly diagonally implicit Runge-Kutta with an explicit first stage solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc}</span>
<span class="sd">            c_1     &amp; 0       &amp; 0       &amp; \\cdots &amp; 0       \\\\</span>
<span class="sd">            \\vdots &amp; a_{21}  &amp; a_{22}  &amp; \\ddots &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\vdots &amp; \\ddots &amp; 0       \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; a_{s2}  &amp; \\cdots &amp; a_{ss}  \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">):</span>

        <span class="n">DIRK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lqsolver</span> <span class="o">=</span> <span class="n">class_solvers_sp</span><span class="o">.</span><span class="n">solver_lq</span><span class="p">()</span>

<div class="viewcode-block" id="ESDIRK.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.ESDIRK.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>

<span class="sd">        The first stage is computed explicitly as</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                M\\mathbf{k}_1 = h\\mathbf{f}(t_n,\\mathbf{y}_n)</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        in contrast with :meth:`SDIRK.tstep_frw`.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lqsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

            <span class="n">J</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">simplified</span><span class="p">:</span>

                <span class="n">F</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">F</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">dFdx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlsolver</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span></div></div>

<div class="viewcode-block" id="RW"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW">[docs]</a><span class="k">class</span> <span class="nc">RW</span><span class="p">(</span><span class="n">RK</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Rosenbrock-Wanner solver.</span>

<span class="sd">    The matrix of coefficients defining the method takes the form:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\begin{array}{c|cccc|cccc|c}</span>
<span class="sd">            c_1     &amp; a_{11}  &amp; 0       &amp; \\cdots &amp; 0       &amp; \\gamma_{11} &amp; 0            &amp; \\cdots &amp; 0            &amp; d_1     \\\\</span>
<span class="sd">            \\vdots &amp; a_{21}  &amp; a_{22}  &amp; \\ddots &amp; \\vdots &amp; \\gamma_{21} &amp; \\gamma_{22} &amp; \\ddots &amp; \\vdots      &amp; \\vdots \\\\</span>
<span class="sd">            \\vdots &amp; \\vdots &amp; \\vdots &amp; \\ddots &amp; 0       &amp; \\vdots      &amp; \\vdots      &amp; \\ddots &amp; \\ddots      &amp; \\vdots \\\\</span>
<span class="sd">            c_s     &amp; a_{s1}  &amp; a_{s2}  &amp; \\cdots &amp; a_{ss}  &amp; \\gamma_{s1} &amp; \\gamma_{s2} &amp; \\cdots &amp; \\gamma_{ss} &amp; d_s \\\\</span>
<span class="sd">            \\hline</span>
<span class="sd">                    &amp; b_1     &amp; \\cdots &amp; \\cdots &amp; b_s     &amp;              &amp;              &amp;         &amp;              &amp;</span>
<span class="sd">            \\end{array}</span>
<span class="sd">        \\end{equation}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">r_tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">s_fac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">f_max</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">f_min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">h_max</span><span class="o">=</span><span class="mf">1.e+3</span><span class="p">,</span> <span class="n">h_min</span><span class="o">=</span><span class="mf">1.e-12</span><span class="p">):</span>

        <span class="n">RK</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">advancing_table</span><span class="p">,</span> <span class="n">estimator_table</span><span class="p">,</span> <span class="n">a_tol</span><span class="p">,</span> <span class="n">r_tol</span><span class="p">,</span> <span class="n">s_fac</span><span class="p">,</span> <span class="n">f_max</span><span class="p">,</span> <span class="n">f_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_min</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spsolver</span> <span class="o">=</span> <span class="n">class_solvers_sp</span><span class="o">.</span><span class="n">solver_sp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lqsolver</span> <span class="o">=</span> <span class="n">class_solvers_sp</span><span class="o">.</span><span class="n">solver_lq</span><span class="p">()</span>

<div class="viewcode-block" id="RW.setup_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.setup_frw">[docs]</a>    <span class="k">def</span> <span class="nf">setup_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Configures the solver for one forward resolution.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">RK</span><span class="o">.</span><span class="n">setup_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dMdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dMdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dMdx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dMdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dMdx</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dfdx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdx</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdt</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_dfdt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdt</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">dfdt</span></div>

<div class="viewcode-block" id="RW.setup_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.setup_adj">[docs]</a>    <span class="k">def</span> <span class="nf">setup_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Configures the solver for one adjoint resolution.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">RK</span><span class="o">.</span><span class="n">setup_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdxdx</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_d2fdxdx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdxdx</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdxdt</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_d2fdxdt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdt</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdxdt</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdxdu</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_d2fdxdu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdxdu</span>

        <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdtdu</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdtdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd_d2fdtdu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdtdu</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">d2fdtdu</span></div>

<div class="viewcode-block" id="RW.updat_lmb"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.updat_lmb">[docs]</a>    <span class="k">def</span> <span class="nf">updat_lmb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the adjoint state after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1">#TODO Check formula</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="RW.updat_grd"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.updat_grd">[docs]</a>    <span class="k">def</span> <span class="nf">updat_grd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the gradient of the cost function after one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdtdu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grd</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2fdtdu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> \
                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdu_step</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="RW.stage_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.stage_frw">[docs]</a>    <span class="k">def</span> <span class="nf">stage_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RW.stage_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.stage_adj">[docs]</a>    <span class="k">def</span> <span class="nf">stage_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute matrices and vectors required for one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx_step</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgdu_step</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_frw</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dfdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dMdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dMdu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d2fdxdu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgdu_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgdu</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span></div>

<div class="viewcode-block" id="RW.tstep_frw"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.tstep_frw">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_frw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one forward time step.</span>

<span class="sd">        The stages are computed by solving the non-linear systems</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\begin{split}</span>
<span class="sd">                (M-h\\gamma J)\\mathbf{k}_i = &amp; h\\mathbf{f}(t_n + c_ih, \\mathbf{x}_n+\sum_{j=1}^{i-1}a_{ij}\\mathbf{k}_j) + hJ\\sum_{j=1}^{i-1}\\gamma_{ij}\\mathbf{k}_j \\\\</span>
<span class="sd">                                          + &amp; h^2d_i\\frac{\\partial \\mathbf{f}}{\\partial t}(t_n, \\mathbf{x}_n),\\quad i=1,\\dots, s</span>
<span class="sd">                \\end{split}</span>
<span class="sd">            \\end{equation}</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">):</span>
            <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdx</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdt</span><span class="p">):</span>
            <span class="n">dfdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdt</span>

        <span class="c1">#TODO Split in more functions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

            <span class="n">ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>

            <span class="n">xi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">;</span> <span class="n">sum_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>

                <span class="n">xi</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:];</span> <span class="n">sum_x</span> <span class="o">=</span> <span class="n">sum_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">dfdx</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sum_x</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfdt</span><span class="p">)</span></div>

<div class="viewcode-block" id="RW.tsetp_tlm"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.tsetp_tlm">[docs]</a>    <span class="k">def</span> <span class="nf">tsetp_tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#TODO</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;TLM not ready fro RW&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RW.tstep_adj"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.tstep_adj">[docs]</a>    <span class="k">def</span> <span class="nf">tstep_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Performs one adjoint time step.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Matrix</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Loop in stages</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># Vector</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmb</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>

                <span class="c1"># Auxiliar matrix</span>
                <span class="n">B_ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">G_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">B_ij</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">B_ij</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">advancing_table</span><span class="o">.</span><span class="n">A_T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgdx_step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

            <span class="c1"># Solve linear system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spsolver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span></div>

<div class="viewcode-block" id="RW.fd_dfdt"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.fd_dfdt">[docs]</a>    <span class="k">def</span> <span class="nf">fd_dfdt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes source derivative with respect to time by finite differences.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\partial\\mathbf{f}}{\partial t}(t, \\mathbf{x}) = \\lim_{h\\rightarrow 0}\\frac{\\mathbf{f}(t + h, \\mathbf{x}) - \\mathbf{f}(t, \\mathbf{x})}{h}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        Args:</span>
<span class="sd">            t (:obj:`float`): Time.</span>
<span class="sd">            x (:obj:`numpy.ndarray`): State.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dfdt (:obj:`numpy.ndarray`): Source derivatives with respect to time.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># First order</span>
            <span class="n">dfdt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
           <span class="c1"># Second order</span>
           <span class="n">dfdt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
           <span class="c1"># Fourth order</span>
           <span class="n">dfdt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">48.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">36.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> \
                                                <span class="o">+</span> <span class="mf">16.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">25.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Possible order reduction, using fourth order finite differences on time...&quot;</span><span class="p">)</span>
            <span class="n">dfdt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">48.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">36.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> \
                                                 <span class="o">+</span> <span class="mf">16.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">25.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dfdt</span></div>

<div class="viewcode-block" id="RW.fd_dMdt"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.fd_dMdt">[docs]</a>    <span class="k">def</span> <span class="nf">fd_dMdt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes matrix derivative with respect to time by finite differences.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\partial M}{\partial t}(t, \\mathbf{x}) = \\lim_{h\\rightarrow 0}\\frac{M(t + h, \\mathbf{x}) - M(t, \\mathbf{x})}{h}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        Args:</span>
<span class="sd">            t (:obj:`float`): Time.</span>
<span class="sd">            x (:obj:`numpy.ndarray`): State.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dMdt (:obj:`numpy.ndarray`): Matrix derivatives with respect to time.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># First order</span>
            <span class="n">dMdt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Second order</span>
            <span class="n">dMdt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="c1"># Fourth order</span>
            <span class="n">dMdt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">48.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">36.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> \
                                                 <span class="o">+</span> <span class="mf">16.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">25.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Possible order reduction, using fourth order finite differences on time...&quot;</span><span class="p">)</span>

            <span class="n">dMdt</span> <span class="o">=</span> <span class="p">(</span><span class="mf">48.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">36.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> \
                                                 <span class="o">+</span> <span class="mf">16.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">25.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">12.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dMdt</span></div>

<div class="viewcode-block" id="RW.fd_d2fdxdx"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.fd_d2fdxdx">[docs]</a>    <span class="k">def</span> <span class="nf">fd_d2fdxdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes source second order directional derivative with respect to state by finite differences.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\partial^2\\mathbf{f}}{\partial \mathbf{x}^2}(t, \\mathbf{x})\mathbf{y} = \\lim_{\\epsilon\\rightarrow 0}\\frac{\\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t, \\mathbf{x} + \\epsilon\\mathbf{y}) - \\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t, \\mathbf{x})}{\\epsilon}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        Args:</span>
<span class="sd">            t (:obj:`float`): Time.</span>
<span class="sd">            x (:obj:`numpy.ndarray`): State.</span>
<span class="sd">            y (:obj:`numpy.ndarray`): Direction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (:obj:`numpy.ndarray`): Source second order derivatives with respect to state.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span></div>

<div class="viewcode-block" id="RW.fd_d2fdxdt"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.fd_d2fdxdt">[docs]</a>    <span class="k">def</span> <span class="nf">fd_d2fdxdt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes source second order derivative with respect to time and state by finite differences.</span>

<span class="sd">        .. math::</span>
<span class="sd">            \\begin{equation}</span>
<span class="sd">                \\frac{\partial^2\\mathbf{f}}{\partial \mathbf{x}\partial t}(t, \\mathbf{x}) = \\lim_{h\\rightarrow 0}\\frac{\\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t + h, \\mathbf{x}) - \\frac{\\partial \\mathbf{f}}{\\partial \\mathbf{x}}(t, \\mathbf{x})}{h}</span>
<span class="sd">            \\end{equation}</span>

<span class="sd">        Args:</span>
<span class="sd">            t (:obj:`float`): Time.</span>
<span class="sd">            x (:obj:`numpy.ndarray`): State.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (:obj:`numpy.ndarray`): Source second order derivatives with respect to time and state.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdx</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span></div>

<div class="viewcode-block" id="RW.fd_d2fdxdu"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.fd_d2fdxdu">[docs]</a>    <span class="k">def</span> <span class="nf">fd_d2fdxdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes source second order derivative with respect to the state and control by finite differences.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RW.fd_d2fdtdu"><a class="viewcode-back" href="../../source/fatDAE.html#fatDAE.class_solvers.RW.fd_d2fdtdu">[docs]</a>    <span class="k">def</span> <span class="nf">fd_d2fdtdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes source second order derivative with respect to the time and control by finite differences.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Feature not implemented yet...&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Manuel Cremades

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>